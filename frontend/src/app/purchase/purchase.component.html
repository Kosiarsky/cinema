<app-header></app-header>

<div class="second-container mt-4 text-light">
  <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center" style="min-height:200px;">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Ładowanie...</span></div>
  </div>

  <div *ngIf="!isLoading && schedule">
    <div class="py-3 pb-1 bar-border">
        <h2 class="red-border-bar-big text-center">
            {{ schedule?.movie?.title || 'Seans' }}
        </h2>
    </div>
    <p class="text-center mb-3">
      {{ schedule?.date | date:'dd.MM.yyyy' }} • {{ schedule?.time }} • Sala {{ schedule?.hall }} 
    </p>

    <div *ngIf="showStarted" class="alert alert-danger text-center" role="alert">
      Seans już się rozpoczął. Zakup biletów jest niedostępny.
    </div>

    <div *ngIf="sessionExpired" id="errorMessage" class="text-danger mb-3" role="alert">
      Sesja zakupu wygasła. Wybierz miejsca ponownie.
    </div>

    <div *ngIf="paymentCanceled" class="alert alert-warning mb-3" role="alert">
      Płatność Stripe została anulowana. Możesz spróbować ponownie.
    </div>

    <div *ngIf="!isLoading && !schedule" id="errorMessage" class="text-danger mb-3">
        Brak seansu!
    </div>

    <div *ngIf="maxSeatsMessage != null && selectedSeats.size >= maxSeats" id="errorMessage" class="text-danger mb-3 my-3">
        {{ maxSeatsMessage }}
    </div>

    <div *ngIf="!showStarted" class="repertoire-card flex-column justify-content-center px-6">

        <div *ngIf="!checkoutMode" class="d-flex justify-content-center">
            <div class="mx-2">
                <div class="d-flex justify-content-center mb-3"><div class="screen">Ekran</div></div>

                <div class="seat-layout">
                    <div class="seat-grid">
                        <div class="row m-0 justify-content-start">
                            <div class="row-label seat2">RZĄD</div>
                        </div>
                        <div class="row m-0" *ngFor="let row of seatMatrix; let r = index">
                            <div class="row-label seat2">{{ rowLabel(r) }}</div>
                            <div
                                class="seat"
                                [class.available]="isSeatAvailable(r,c) && !selectedSeats.has(r + '-' + c)"
                                [class.selected]="selectedSeats.has(r + '-' + c)"
                                [class.blocked]="!isSeatAvailable(r,c) && !selectedSeats.has(r + '-' + c)"
                                *ngFor="let seat of row; let c = index"
                                (click)="toggleSeat(r,c)"
                            >
                                {{ c + 1 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="exit-indicator mx-2 my-3">WYJŚCIE</div>
        </div>

        <div *ngIf="!checkoutMode && !showStarted" class="d-flex w-100 justify-content-center text-center">
            <div class="legend my-3 d-inline-flex gap-3 text-center">
                <span><span class="box" style="background:#2d6a4f"></span>Dostępne</span>
                <span><span class="box" style="background:#1d3557"></span>Wybrane</span>
                <span><span class="box" style="background:#9e2a2b"></span>Zablokowane</span>
            </div>
        </div>


        <div *ngIf="checkoutMode && !showStarted" class="checkout-panel w-100">
          <h5 class="text-center mb-3">Podsumowanie</h5>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Rząd</th>
                  <th>Miejsce</th>
                  <th>Typ</th>
                  <th class="text-end">Cena</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of checkoutItems; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ item.rowLabel }}</td>
                  <td>{{ item.seatNumber }}</td>
                  <td>
                    <select class="form-select form-select-sm bg-dark text-light" [(ngModel)]="item.type" (ngModelChange)="onTypeChange(item)">
                      <option *ngFor="let p of ticketPrices" [value]="p.type">{{ p.type }}</option>
                    </select>
                  </td>
                  <td class="text-end">{{ item.price | number:'1.2-2' }} zł</td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="4" class="text-end">Razem:</th>
                  <th class="text-end">{{ totalPrice | number:'1.2-2' }} zł</th>
                </tr>
              </tfoot>
            </table>
          </div>
          <div *ngIf="paymentError" class="text-danger text-center my-2">{{ paymentError }}</div>
          <div class="text-center my-3 d-flex justify-content-center gap-2 flex-wrap">
            <button class="btn btn-primary ml-3" [disabled]="isPaying" (click)="pay()">Zapłać</button>
          </div>
        </div>
    </div>

    <div class="text-center mt-3">
      <span class="visually-hidden">Wybrane miejsca: <b>{{ selectedCount }}</b> / {{ maxSeats }}</span>
      <div *ngIf="holdCountdown" class="mt-1">
        Blokada miejsc wygasa za: <b>{{ holdCountdown }}</b>
      </div>
    </div>
   
    <div class="text-center mt-3 mb-3" *ngIf="!showStarted">
      <button class="btn btn-primary ml-3" [disabled]="selectedCount === 0 || sessionExpired" (click)="proceedToPayment()" *ngIf="!checkoutMode">Przejdź do płatności</button>
    </div>
    <div class="text-center mt-3 mb-3" *ngIf="checkoutMode && !showStarted">
      <button class="btn btn-primary ml-3" (click)="checkoutMode=false">Wróć do wyboru miejsc</button>
    </div>
    <div class="text-center mt-3 mb-3">
      <a routerLink="/repertoire" class="btn btn-primary mr-3">Wróć</a>
    </div>
  </div>
</div>


<app-footer></app-footer>