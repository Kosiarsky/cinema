<div *ngIf="isLoading" class="card profile-card-body d-flex justify-content-center align-items-center" style="min-height: 200px;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Ładowanie...</span>
  </div>
</div>
<div *ngIf="!isLoading">
    <div *ngIf="tickets.length; else noTickets">
        <ul class="list-group">
            <li class="card repertoire-card mb-4 d-flex flex-column flex-md-row align-items-md-start align-items-center" *ngFor="let ticket of tickets">
                <img [src]="toAbs(ticket.schedule?.movie.image)" class="repertoire-card-img pointer" alt="{{ ticket.schedule?.movie.title }}" routerLink="/movie/{{ ticket.schedule?.movie.id }}">
                <div class="repertoire-card-body flex-grow-1">
                    <h3 class="repertoire-card-title pointer" routerLink="/movie/{{ ticket.schedule?.movie.id }}">{{ ticket.schedule?.movie.title }}</h3>
                    <p class="repertoire-card-text">
                        <b>{{ ticket.schedule?.date | date:'dd.MM.yyyy' }}</b> | 
                        <b>{{ ticket.schedule?.time }}</b> | 
                        <b>Sala {{ ticket.hall || 'brak' }}</b>
                    </p>
                    <div *ngFor="let seat of ticket.seats" class="mb-2">
                        <div class="d-flex repertoire-border flex-wrap px-2">
                            <span class="repertoire-card-text">Miejsce: <b>{{ seat.seat }}</b></span>
                            <span class="flex-fill repertoire-card-text px-4">Bilet: <b>{{ seat.type }}</b></span>
                            <span class="repertoire-card-text ms-2"><b>{{ seat.price }} ZŁ</b></span>
                        </div>
                    </div>
                    <div class="d-flex repertoire-border-red px-2 ">
                        <div class="flex-fill repertoire-card-big-text"><b>Cena łączna:</b></div>
                        <div class="repertoire-card-big-text ms-2 mb-md-4"><b>{{ ticket.total_price }} ZŁ</b></div>
                    </div>
                    <div class="mt-2 repertoire-border px-2">
                        <span class="repertoire-card-text">Kod biletu: <b>{{ ticket.ticket_code }}</b></span>
                    </div>

                    <div class="mt-3">
                      <button class="btn btn-secondary" (click)="toggleReview(ticket.id)">
                        {{ showReviewFor[ticket.id] ? 'Anuluj' : 'Oceń ten film' }}
                      </button>
                    </div>

                    <div *ngIf="showReviewFor[ticket.id]" class="mt-3 p-3 announcements-card rounded flex-column">
                      <div>Twoja ocena:</div>
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <ng-container *ngFor="let star of [1,2,3,4,5]">
                          <span
                            class="pointer"
                            (click)="setRating(ticket.id, star)"
                            (mouseenter)="setHover(ticket.id, star)"
                            (mouseleave)="setHover(ticket.id, null)"
                            (keydown.enter)="setRating(ticket.id, star)"
                            tabindex="0"
                            role="button"
                            [attr.aria-label]="'Oceń na ' + star + ' gwiazdek'"
                          >
                            <i [ngClass]="getDisplayedRating(ticket.id) >= star ? 'fa-solid fa-star text-warning' : 'fa-regular fa-star text-secondary'"></i>
                          </span>
                        </ng-container>
                        <span class="ms-2">{{ getDisplayedRating(ticket.id) || 0 }}/5</span>
                        
                      </div>
                      <div class="mb-2">
                        <textarea class="form-control form-control-sm" rows="3" [(ngModel)]="reviewForms[ticket.id]!.comment" placeholder="Opcjonalna recenzja..."></textarea>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="anon-{{ticket.id}}" [(ngModel)]="reviewForms[ticket.id]!.is_anonymous">
                        <label class="form-check-label" for="anon-{{ticket.id}}">Publikuj anonimowo</label>
                      </div>
                      <button class="btn btn-primary btn-sm" (click)="submitReview(ticket)">Wyślij ocenę</button>
                    </div>
                </div>
                <img [src]="ticket.qr_code_data_url" class="repertoire-card-qr" alt="Kod QR biletu" />
            </li>
        </ul>
    </div>
    <ng-template #noTickets>
        <div class="profile-card-body p-4">
            <div class="text-center">
                <b>Nie masz jeszcze żadnych biletów w historii!</b> 
                <br>
                <a routerLink="/repertoire" class="btn btn-primary mt-3">PRZEJDŹ DO REPERTUARU</a>
            </div>
        </div>
    </ng-template>
</div>